## 摘要


**总结：重点在于热点探测的方法和在 Flink 中实现算子的状态合并的方法，而不是调度算法。**

一个自动的，热点感知的动态负载平衡系统的流数据流。它采用了一个集中式调度器，动态监控整个数据流的负载平衡，并实现相应的状态迁移。调度器使用简单的异步分布式控制消息机制和热点减少算法来实现这两个任务。定时机制支持隐式障碍和高效的状态迁移，而没有全局障碍或暂停操作员。它还支持基于时间窗口的负载平衡测量，并将它们馈送到热点减少算法，而无需用户干扰。

## 解决问题

数据倾斜导致的阻塞，负载均衡

## 当前的缓解阻塞的方法

![[预聚合和重Hash.png]]

## 方法

### 探测热点 

1. 使用空的控制消息，打上时间戳，收到 `timestamp = 200` 说明 200 以前的数据全部拿到，此时可以与其他的同级别的 `timestamp = 200` 的算子合并。
2.  每个算子会把相同的控制消息广播发送到与所有子节点，在窗口收到上游所有算子的时间戳后，会把统计结果与控制消息一起发送到调度器，以供分析。

### 合并状态

1. 无状态算子：使用buffer，收到控制消息（指示算子下发的路由表的更改，如`算子 1-0` 改为 `算子 1-1` ）后，先需暂存需要由 `算子 1` 发到 `0` 的数据,其余数据不变往下发，当算子收到所有的上游控制消息后（可能有多人算子往此算子发送消息），改变每个算子的发送的下游算子，再将控制消息往下广播，暂存的数据也往下发。
![[有状态算子合并 1.png]]
3. 有状态算子：与无状态类似，左右两个 reducer 都会接收到控制消息，左边的会继续工作，右边的收到后会初始化迁移 slot 和 buffer，并把 控制消息 `6` 后的 `8` 暂存。在左边的 reducer 收到所有的 控制消息后，就会把 左边的 `slot_r_0_1` 发送到右边。最终右边的 reducer 将根据 state 把暂存的数据放到对应的 slot 中。

![[論文/有状态算子合并.png]]


## 调度

通过调度器检查算子的不同并行度之间的相同时间段内的吞吐量差异，通过背包问题和 First-fit 来调整每个算子的输入输出路径。

